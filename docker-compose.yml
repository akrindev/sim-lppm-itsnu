services:
  # PHP Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER:-local}/sim-lppm-app:latest
    container_name: sim-lppm-app
    restart: unless-stopped
    working_dir: /var/www
    volumes:
      - .:/var/www
    networks:
      - sim-lppm-network
    depends_on:
      mariadb:
        condition: service_healthy
      redis:
        condition: service_started

  # Web Server (Nginx)
  web:
    image: nginx:alpine
    container_name: sim-lppm-web
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8000}:80"
    volumes:
      - .:/var/www
      - .docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
    networks:
      - sim-lppm-network
    depends_on:
      - app

  # Database (MariaDB)
  mariadb:
    image: mariadb:11
    container_name: sim-lppm-db
    restart: unless-stopped
    ports:
      - "127.0.0.1:${FORWARD_DB_PORT:-33060}:3306"
    environment:
      MARIADB_DATABASE: ${DB_DATABASE:-laravel}
      MARIADB_ROOT_PASSWORD: ${DB_PASSWORD:-root}
      MARIADB_PASSWORD: ${DB_PASSWORD:-root}
      MARIADB_USER: ${DB_USERNAME:-root}
    volumes:
      - sim-lppm-db-data:/var/lib/mysql
    networks:
      - sim-lppm-network
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-p${DB_PASSWORD:-root}"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Redis for Cache & Queues
  redis:
    image: redis:alpine
    container_name: sim-lppm-redis
    restart: unless-stopped
    ports:
      - "127.0.0.1:${FORWARD_REDIS_PORT:-63790}:6379"
    networks:
      - sim-lppm-network

  # Queue Worker
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sim-lppm-worker
    restart: unless-stopped
    entrypoint: []
    command: php artisan queue:work --tries=3 --timeout=300
    volumes:
      - .:/var/www
    networks:
      - sim-lppm-network
    depends_on:
      - app
      - redis

  # Scheduler (Cron)
  cron:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sim-lppm-cron
    restart: unless-stopped
    entrypoint: []
    command: sh -c "while [ true ]; do php artisan schedule:run --verbose --no-interaction & sleep 60; done"
    volumes:
      - .:/var/www
    networks:
      - sim-lppm-network
    depends_on:
      - app

  # MailCatcher (Mailpit)
  mailpit:
    image: axllent/mailpit
    container_name: sim-lppm-mailpit
    restart: unless-stopped
    ports:
      - "${FORWARD_MAILPIT_PORT:-1025}:1025"
      - "${FORWARD_MAILPIT_DASHBOARD_PORT:-8025}:8025"
    networks:
      - sim-lppm-network

networks:
  sim-lppm-network:
    driver: bridge

volumes:
  sim-lppm-db-data:
    driver: local
